<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
    <div class="container d-flex flex-column justify-content-center align-items-center vh-100">
        <h1 class="mb-3">Exam Monitoring</h1>
        <div class="card p-4 text-center shadow-lg">
            <p class="mb-2"><strong>Status:</strong> <span id="status" class="text-warning">Waiting...</span></p>
            <p><strong>Time Remaining:</strong> <span id="timer">02:00:00</span></p>
            <video id="video" width="320" height="240" class="border mt-3" autoplay></video>
            <button class="btn btn-success w-100 mt-3" onclick="startCamera()">Start Exam</button>
            <button class="btn btn-danger w-100 mt-2" onclick="stopCamera()">End Exam</button>
        </div>
    </div>

    <script>
        let timeLeft = 7200; // 2 hours in seconds
        let timerInterval;
        let videoStream;
        let isMonitoring = false;
        let tabSwitchCount = 0;

        function startCamera() {
            fetch('/start_camera')
                .then(response => response.json())
                .then(data => {
                    document.getElementById("status").innerText = "Monitoring Started";
                    document.getElementById("status").classList.replace("text-warning", "text-success");
                    isMonitoring = true;
                    startTimer();
                    startVideo();
                    monitorSuspiciousActivity();
                });
        }

        function stopCamera() {
            fetch('/stop_camera')
                .then(response => response.json())
                .then(data => {
                    document.getElementById("status").innerText = "Monitoring Stopped";
                    document.getElementById("status").classList.replace("text-success", "text-danger");
                    clearInterval(timerInterval);
                    stopVideo();
                    alert("Exam Ended! All suspicious activities are reported.");
                    window.location.href = "/report"; // Redirect to report page
                });
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                let hours = Math.floor(timeLeft / 3600);
                let minutes = Math.floor((timeLeft % 3600) / 60);
                let seconds = timeLeft % 60;
                document.getElementById("timer").innerText = `${hours}:${minutes}:${seconds}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    stopCamera();
                }
                timeLeft--;
            }, 1000);
        }

        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    videoStream = stream;
                    document.getElementById("video").srcObject = stream;
                })
                .catch(error => {
                    console.error("Error accessing webcam: ", error);
                });
        }

        function stopVideo() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        }

        function monitorSuspiciousActivity() {
            setInterval(() => {
                fetch('/check_suspicious')
                    .then(response => response.json())
                    .then(data => {
                        if (data.suspicious) {
                            alert(`Warning! Suspicious Activity Detected: ${data.reason}`);
                            stopCamera();
                        }
                    });
            }, 5000); // Check every 5 seconds
        }

        // Detect tab switching
        document.addEventListener("visibilitychange", function() {
            if (document.hidden && isMonitoring) {
                tabSwitchCount++;
                alert("Tab Switching Detected! Exam Ended.");
                stopCamera();
            }
        });
    </script>
</body>
</html>
